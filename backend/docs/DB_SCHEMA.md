# Symmetry Database Schema & Sync Strategy

This document defines the NoSQL data schema for Firebase Firestore and the "Offline-First" synchronization strategy for the *My Reports* feature.

## 1. Core Collections

### `users` (Collection)
Stores profile information for users (journalists/visitors).
* **Doc ID:** `AuthUID` (provided by Firebase Auth).
* **Fields:**
    * `email` (string): User email address.
    * `displayName` (string): User's full name.
    * `photoURL` (string): Profile picture URL (Empty string if none).
    * `createdAt` (timestamp): Registration date.
* **Sub-Collections:**
    * `saved_articles`: Doc ID = Sanitized Article URL. Contains references to bookmarked articles.
    * `liked_articles`: Doc ID = Article URL (or UUID). Contains references to liked articles.

### `articles` (Collection)
Stores fitness reports created by users. This collection acts as the Global Feed.
* **Doc ID:** Auto-generated by Firestore (or derived from URL in some cases).
* **Fields:**
    * `url` (string): **Primary Key**. UUID v4 generated locally. Used to identify the article across devices.
    * `userId` (string): Reference to the author (`users/{uid}`).
    * `author` (string): Author's name (denormalized for read efficiency).
    * `title` (string): The headline of the fitness news.
    * `description` (string): Auto-generated summary (first 90-250 chars) for list view.
    * `content` (string): The full body of the article.
    * `category` (string): Single selection (e.g., "Nutrition", "Workout", "Mental Health").
    * `urlToImage` (string): Public URL of the cover image in Firebase Storage.
        * *Storage Path:* `media/articles/{userId}/{timestamp}.jpg`
    * `publishedAt` (string ISO-8601): Creation date (used for sorting feed).
    * `likesCount` (int): Global popularity counter.
    * `syncStatus` (string): Indicates sync state. On Firestore, this is always set to `"synced"`.

## 2. Synchronization Strategy (Offline-First)

To strictly comply with the "Offline-First" requirement, the app follows a "Store-and-Forward" pattern:

1.  **Local Write (Floor DB / SQLite):**
    * The article is saved locally first.
    * Assigned status: `syncStatus = 'pending'`.
    * The image is saved to a permanent local path (`ApplicationDocumentsDirectory`).

2.  **Background Sync (SyncWorker/Repository):**
    * Triggered by connectivity changes or app startup.
    * **Step A (Media):** Uploads the local image to Firebase Storage (`media/articles/{uid}/`). Retrieves the `downloadURL`.
    * **Step B (Data):** Performs an **Upsert** (Update or Insert) to Firestore using the article's `url` as the identifier.
        * It sets `syncStatus = 'synced'` and `urlToImage = downloadURL` in the cloud payload.
    * **Step C (Confirm):** Updates the local SQLite record to reflect the new remote image URL and changes status to `synced`.

3. **Soft Delete Strategy:**
    * When a user deletes an article offline, it is marked locally as `syncStatus = 'pending_delete'`.
    * The sync engine detects this flag when online, deletes the remote resources (Firestore Doc + Storage Image), and finally removes the local record.

## 3. Storage Rules Reference
Images are strictly hosted in the `media/articles/{userId}` folder to enforce security rules (users can only write to their own folder).